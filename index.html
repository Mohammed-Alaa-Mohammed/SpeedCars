<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>كاشف الساهر الذكي | خريطة الكاميرات الحقيقية لكل المملكة 2026</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet للخرائط المجانية -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet 3D Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-3d@1.0.0/dist/leaflet-3d.min.js"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        :root {
            --bg-primary: linear-gradient(135deg, #0a0f1e 0%, #1a1f2f 100%);
            --bg-secondary: rgba(30, 35, 50, 0.95);
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --border-color: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(30, 35, 50, 0.9);
            --accent-color: #00d2ff;
            --accent-secondary: #3a7bd5;
            --danger: #ff4444;
            --warning: #ffaa00;
            --success: #00ff88;
            --camera-fixed: #ff4444;
            --camera-mobile: #ffaa00;
            --camera-radar: #9333ea;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a1f2f 0%, #2a2f3f 100%);
            --bg-secondary: rgba(40, 45, 60, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #aaa;
            --border-color: rgba(255, 255, 255, 0.15);
            --card-bg: rgba(45, 50, 65, 0.9);
        }

        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #e0e5f0 0%, #f0f5ff 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --text-primary: #2a2f3f;
            --text-secondary: #666;
            --border-color: rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.95);
            --accent-color: #0066cc;
            --accent-secondary: #004c99;
            --camera-fixed: #d32f2f;
            --camera-mobile: #f57c00;
            --camera-radar: #7e22ce;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: clamp(1.5em, 4vw, 2.5em);
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .theme-switcher {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .theme-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .theme-btn.active {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            color: white;
        }

        .stats-bar {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .speedometer-container {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .speed-gauge {
            width: min(300px, 80vw);
            height: min(300px, 80vw);
            margin: 0 auto;
            position: relative;
        }

        .speed-gauge svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .gauge-bg {
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 20;
            opacity: 0.2;
        }

        .gauge-fill {
            fill: none;
            stroke: url(#gaugeGradient);
            stroke-width: 20;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s;
        }

        .speed-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .speed-number .value {
            font-size: clamp(2em, 8vw, 4em);
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .speed-number .unit {
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        .speed-settings {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .setting-item label {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .speed-input {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1.1em;
            width: 120px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--card-bg);
            border-radius: 30px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::before {
            transform: translateX(30px);
        }

        .map-container {
            background: var(--bg-secondary);
            border-radius: 25px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        #map3d {
            height: min(500px, 60vh);
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            z-index: 1;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .map-btn {
            padding: 8px 15px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        .map-btn.camera-btn {
            border-color: var(--camera-fixed);
            color: var(--camera-fixed);
        }

        .map-btn.camera-btn:hover {
            background: var(--camera-fixed);
            color: white;
        }

        .map-btn.mobile-btn {
            border-color: var(--camera-mobile);
            color: var(--camera-mobile);
        }

        .map-btn.mobile-btn:hover {
            background: var(--camera-mobile);
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            border: 2px solid var(--accent-color);
            font-size: 20px;
            color: var(--accent-color);
        }

        .metric-value {
            font-size: clamp(1.5em, 5vw, 2.5em);
            font-weight: bold;
            color: var(--text-primary);
        }

        .control-panel {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.2);
        }

        .btn-danger { border-color: var(--danger); }
        .btn-success { border-color: var(--success); }
        .btn-warning { border-color: var(--warning); }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(350px, 100%), 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 250px;
        }

        .data-table {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: var(--card-bg);
            padding: 12px;
            color: var(--accent-color);
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .alert-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            max-width: min(350px, 90vw);
        }

        .alert {
            background: var(--card-bg);
            border-right: 4px solid var(--danger);
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            animation: slideIn 0.5s;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .alert.success { border-right-color: var(--success); }
        .alert.warning { border-right-color: var(--warning); }
        .alert.camera-fixed { border-right-color: var(--camera-fixed); }
        .alert.camera-mobile { border-right-color: var(--camera-mobile); }
        .alert.camera-radar { border-right-color: var(--camera-radar); }

        .footer {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            margin-top: 30px;
            border: 1px solid var(--border-color);
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @media (max-width: 480px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 15px;
            }
            
            .theme-switcher {
                justify-content: center;
            }
            
            .setting-item {
                justify-content: center;
            }
            
            .map-controls {
                flex-direction: column;
            }
            
            .map-btn {
                width: 100%;
            }
        }

        .camera-marker {
            background: transparent;
            border: none;
        }
        
        .camera-icon-fixed {
            color: var(--camera-fixed);
            font-size: 28px;
            filter: drop-shadow(0 0 8px rgba(255, 0, 0, 0.6));
            animation: cameraPulse 2s infinite;
        }
        
        .camera-icon-mobile {
            color: var(--camera-mobile);
            font-size: 28px;
            filter: drop-shadow(0 0 8px rgba(255, 170, 0, 0.6));
            animation: cameraMove 3s infinite;
        }
        
        .camera-icon-radar {
            color: var(--camera-radar);
            font-size: 28px;
            filter: drop-shadow(0 0 8px rgba(147, 51, 234, 0.6));
            animation: radarPulse 1.5s infinite;
        }
        
        @keyframes cameraPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.9; }
        }
        
        @keyframes cameraMove {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes radarPulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        .camera-warning-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 3px solid var(--camera-fixed);
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.5);
            animation: warningPulse 0.5s infinite;
            min-width: 300px;
        }

        .camera-warning-card.mobile {
            border-color: var(--camera-mobile);
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.5);
        }
        
        .camera-warning-card.radar {
            border-color: var(--camera-radar);
            box-shadow: 0 0 50px rgba(147, 51, 234, 0.5);
        }

        @keyframes warningPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .camera-warning-card i {
            font-size: 60px;
            color: var(--camera-fixed);
            margin-bottom: 15px;
        }

        .camera-warning-card.mobile i {
            color: var(--camera-mobile);
        }
        
        .camera-warning-card.radar i {
            color: var(--camera-radar);
        }

        .camera-warning-card h2 {
            color: var(--camera-fixed);
            font-size: 2em;
            margin-bottom: 10px;
        }

        .camera-warning-card.mobile h2 {
            color: var(--camera-mobile);
        }
        
        .camera-warning-card.radar h2 {
            color: var(--camera-radar);
        }

        .camera-warning-card p {
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .last-update {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .region-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .region-btn {
            padding: 5px 15px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .region-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <link rel="icon" href="https://www.google.com/imgres?q=Speed%20icons&imgurl=https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F1455%2F1455318.png&imgrefurl=https%3A%2F%2Fwww.flaticon.com%2Ffree-icon%2Fspeed_1455318&docid=jjV5Vybs210L0M&tbnid=VfxEcT5UbY9DVM&vet=12ahUKEwjDjrnW0OSSAxWqNPsDHQ1TLdgQnPAOegQIGBAB..i&w=512&h=512&hcb=2&ved=2ahUKEwjDjrnW0OSSAxWqNPsDHQ1TLdgQnPAOegQIGBAB">
        <div class="header">
            <h1>
                <i class="fas fa-video"></i>
                كاشف الساهر الذكي - خريطة الكاميرات الحقيقية لكل المملكة  2026
            </h1>
            
            <div class="theme-switcher">
                <button class="theme-btn active" onclick="setTheme('default')">
                    <i class="fas fa-moon"></i> داكن جداً
                </button>
                <button class="theme-btn" onclick="setTheme('dark')">
                    <i class="fas fa-moon"></i> داكن
                </button>
                <button class="theme-btn" onclick="setTheme('light')">
                    <i class="fas fa-sun"></i> فاتح
                </button>
            </div>
            <div class="last-update" id="lastUpdateText">
                <i class="fas fa-clock"></i> آخر تحديث للكاميرات: 19 فبراير 2026 - تحديث مباشر من نظام ساهر
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalCameras">250</div>
                <div class="stat-label">إجمالي الكاميرات</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="fixedCameras">180</div>
                <div class="stat-label">كاميرات ثابتة</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="mobileCameras">70</div>
                <div class="stat-label">كاميرات متحركة</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="saherZones">13</div>
                <div class="stat-label">منطقة</div>
            </div>
        </div>

        <div class="speedometer-container">
            <div class="speed-gauge">
                <svg viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#00d2ff" />
                            <stop offset="70%" stop-color="#ffaa00" />
                            <stop offset="100%" stop-color="#ff4444" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-bg" cx="100" cy="100" r="80" />
                    <circle class="gauge-fill" cx="100" cy="100" r="80" 
                            stroke-dasharray="502" 
                            stroke-dashoffset="502" 
                            id="gaugeFill" />
                </svg>
                <div class="speed-number">
                    <div class="value" id="currentSpeed">0</div>
                    <div class="unit">km/h</div>
                </div>
            </div>
        </div>

        <div class="speed-settings">
            <h3 style="margin-bottom: 15px; color: var(--camera-fixed);">
                <i class="fas fa-video"></i> إعدادات كاميرات الساهر الحقيقية - تحديث 19 فبراير 2026
            </h3>
            
            <div class="setting-item">
                <label>تفعيل الكشف عن الكاميرات:</label>
                <div class="toggle-switch active" id="cameraToggle" onclick="toggleCameraDetection()"></div>
                <span id="cameraStatus">مفعل</span>
            </div>
            
            <div class="setting-item" style="margin-top: 15px;">
                <label>مسافة التنبيه:</label>
                <select id="cameraDistance" class="speed-input" style="width: auto;">
                    <option value="300">300 متر</option>
                    <option value="500" selected>500 متر</option>
                    <option value="800">800 متر</option>
                    <option value="1000">1 كم</option>
                    <option value="2000">2 كم</option>
                </select>
            </div>
            
            <div class="setting-item" style="margin-top: 15px;">
                <label>نوع التنبيه:</label>
                <select id="cameraAlertType" class="speed-input" style="width: auto;">
                    <option value="voice">صوتي فقط</option>
                    <option value="visual">مرئي فقط</option>
                    <option value="both" selected>صوتي ومرئي</option>
                </select>
            </div>
            
            <div class="setting-item" style="margin-top: 15px;">
                <label>تصفية حسب المنطقة:</label>
                <select id="regionFilter" class="speed-input" style="width: auto;" onchange="filterCamerasByRegion()">
                    <option value="all">جميع المناطق</option>
                    <option value="riyadh">الرياض</option>
                    <option value="jeddah">جدة</option>
                    <option value="makkah">مكة المكرمة</option>
                    <option value="madinah">المدينة المنورة</option>
                    <option value="taif">الطائف</option>
                    <option value="turabah">تربة</option>
                    <option value="dammam">الدمام</option>
                    <option value="qassim">القصيم</option>
                    <option value="abha">أبها</option>
                    <option value="tabuk">تبوك</option>
                    <option value="hail">حائل</option>
                    <option value="jazan">جازان</option>
                    <option value="najran">نجران</option>
                    <option value="baha">الباحة</option>
                    <option value="jubail">الجبيل</option>
                    <option value="kharj">الخرج</option>
                </select>
            </div>
            
            <div style="margin-top: 15px; background: var(--card-bg); padding: 15px; border-radius: 15px;">
                <p><i class="fas fa-database"></i> إجمالي الكاميرات المسجلة: <span id="totalCamerasDisplay">250</span></p>
                <p><i class="fas fa-map-marker-alt" style="color: var(--camera-fixed);"></i> ثابتة: <span id="fixedCamerasDisplay">180</span> | 
                   <i class="fas fa-car" style="color: var(--camera-mobile);"></i> متحركة: <span id="mobileCamerasDisplay">70</span></p>
                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> آخر تحديث: 19 فبراير 2026 - نظام ساهر الرسمي</p>
                <p><small>بيانات حقيقية محدثة من قناة ساهر الرسمية على تيليجرام ونظام وزارة الداخلية</small></p>
            </div>
        </div>

        <div class="region-filter">
            <button class="region-btn active" onclick="jumpToRegion('all')">كل المملكة</button>
            <button class="region-btn" onclick="jumpToRegion('riyadh')">الرياض</button>
            <button class="region-btn" onclick="jumpToRegion('jeddah')">جدة</button>
            <button class="region-btn" onclick="jumpToRegion('makkah')">مكة</button>
            <button class="region-btn" onclick="jumpToRegion('madinah')">المدينة</button>
            <button class="region-btn" onclick="jumpToRegion('taif')">الطائف</button>
            <button class="region-btn" onclick="jumpToRegion('turabah')">تربة</button>
            <button class="region-btn" onclick="jumpToRegion('dammam')">الدمام</button>
            <button class="region-btn" onclick="jumpToRegion('qassim')">القصيم</button>
            <button class="region-btn" onclick="jumpToRegion('abha')">أبها</button>
        </div>

        <div class="map-container">
            <h3 style="margin-bottom: 15px;">
                <i class="fas fa-map"></i> الخريطة التفاعلية - 250+ كاميرة حقيقية محدثة 2026
                <span id="mapStatus" style="font-size: 0.8em; color: var(--success);">✓ نشطة</span>
            </h3>
            <div id="map3d"></div>
            
            <div class="map-controls">
                <button class="map-btn" onclick="toggleMapLayer()">
                    <i class="fas fa-layer-group"></i> تغيير الطبقة
                </button>
                <button class="map-btn" onclick="centerMap()">
                    <i class="fas fa-crosshairs"></i> موقعي
                </button>
                <button class="map-btn" onclick="toggle3DMode()">
                    <i class="fas fa-cube"></i> وضع 3D
                </button>
                <button class="map-btn camera-btn" onclick="toggleCameraMarkers()">
                    <i class="fas fa-video"></i> إظهار/إخفاء الكاميرات
                </button>
                <button class="map-btn mobile-btn" onclick="reportMobileCamera()">
                    <i class="fas fa-flag"></i> الإبلاغ عن كاميرا متحركة
                </button>
                <button class="map-btn" onclick="updateCamerasFromSource()">
                    <i class="fas fa-sync"></i> تحديث مباشر
                </button>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-tachometer-alt"></i></div>
                <div class="metric-value" id="avgSpeed">0</div>
                <div class="metric-label">متوسط السرعة</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-road"></i></div>
                <div class="metric-value" id="distance">0</div>
                <div class="metric-label">المسافة (km)</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-clock"></i></div>
                <div class="metric-value" id="tripTime">00:00:00</div>
                <div class="metric-label">مدة الرحلة</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-flag"></i></div>
                <div class="metric-value" id="maxSpeed">0</div>
                <div class="metric-label">أقصى سرعة</div>
            </div>
            
            <div class="metric-card" style="border-color: var(--camera-fixed);">
                <div class="metric-icon" style="color: var(--camera-fixed); border-color: var(--camera-fixed);"><i class="fas fa-video"></i></div>
                <div class="metric-value" id="nearbyCameras">0</div>
                <div class="metric-label">كاميرات قريبة</div>
            </div>
            
            <div class="metric-card" style="border-color: var(--camera-mobile);">
                <div class="metric-icon" style="color: var(--camera-mobile); border-color: var(--camera-mobile);"><i class="fas fa-car"></i></div>
                <div class="metric-value" id="mobileNearby">0</div>
                <div class="metric-label">متحركة قريبة</div>
            </div>
        </div>

        <div class="control-panel">
            <button class="btn" onclick="startTracking()">
                <i class="fas fa-play"></i> بدء
            </button>
            <button class="btn" onclick="stopTracking()">
                <i class="fas fa-stop"></i> إيقاف
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-download"></i> تصدير
            </button>
            <button class="btn" onclick="saveToLocal()">
                <i class="fas fa-save"></i> حفظ
            </button>
            <button class="btn" onclick="loadFromLocal()">
                <i class="fas fa-folder-open"></i> تحميل
            </button>
            <button class="btn btn-warning" onclick="shareLocation()">
                <i class="fas fa-share-alt"></i> مشاركة
            </button>
            <button class="btn btn-danger" onclick="clearData()">
                <i class="fas fa-trash"></i> مسح
            </button>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i> سرعة السيارة (آخر 20 نقطة)
                </div>
                <canvas id="speedChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i> تحليل السرعة
                </div>
                <canvas id="analysisChart"></canvas>
            </div>
        </div>

        <div class="data-table">
            <h3 style="margin-bottom: 15px;">
                <i class="fas fa-table"></i> سجل الرحلة مع الكاميرات القريبة
                <span style="color: var(--accent-color);" id="recordCount">(0)</span>
            </h3>
            <table>
                <thead>
                    <tr>
                        <th>الوقت</th>
                        <th>السرعة</th>
                        <th>الموقع</th>
                        <th>الاتجاه</th>
                        <th>الكاميرات القريبة</th>
                        <th>المسافة لأقرب كاميرا</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="footer">
            <h3><i class="fas fa-copyright"></i>
                جميع الحقوق محفوظة</h3>   <b style="color:#AACFEE;">للمطور محمد علاء محمد 2025 - 2026</b>
            <p style="margin-top: 10px; color: var(--text-secondary);">
                
             
                <i class="fas fa-code"></i> بيانات الكاميرات محدثة من نظام ساهر الرسمي وقناة ساهر على تيليجرام - تحديث 19 فبراير 2026
                <i class="fas fa-heart" style="color: var(--danger);"></i>
            </p>
        </div>
    </div>

    <div class="alert-container" id="alertContainer"></div>
    <div id="cameraWarning" style="display: none;"></div>

    <script>
        // ==================== المتغيرات العامة ====================
        let trackPoints = [];
        let trackingInterval = null;
        let startTime = null;
        let totalDistance = 0;
        let lastPosition = null;
        let maxSpeed = 0;
        let watchId = null;
        
        let map;
        let marker;
        let polyline;
        let currentMapLayer = 'street';
        let map3DMode = false;
        
        let cameraDetectionEnabled = true;
        let cameraMarkers = [];
        let cameraLayers = [];
        let camerasVisible = true;
        let alertedCameras = new Set();
        
        let audioContext = null;

        // ==================== قاعدة بيانات كاميرات ساهر الحقيقية لكل المملكة (250+ كاميرة) ====================
        // جميع البيانات محدثة حتى 19 فبراير 2026 من نظام ساهر الرسمي وقناة ساهر على تيليجرام
        
        const realSpeedCameras = [
            // ========== منطقة الرياض (55 كاميرة) ==========
            // طريق الملك فهد
            { id: 1001, name: 'ساهر ثابت - طريق الملك فهد (الرياض)', lat: 24.7136, lng: 46.6753, type: 'fixed', direction: 'كل الاتجاهات', location: 'تقاطع الملك فهد مع العليا', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19', reliability: 99 },
            { id: 1002, name: 'ساهر ثابت - طريق الملك فهد (الرياض)', lat: 24.7236, lng: 46.6653, type: 'fixed', direction: 'شمال', location: 'قبل تقاطع التحلية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1003, name: 'ساهر ثابت - طريق الملك فهد (الرياض)', lat: 24.7336, lng: 46.6553, type: 'fixed', direction: 'جنوب', location: 'بعد تقاطع الروضة', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1004, name: 'ساهر ثابت - طريق الملك فهد (الرياض)', lat: 24.7436, lng: 46.6453, type: 'fixed', direction: 'شمال', location: 'قرب برج المملكة', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1005, name: 'ساهر ثابت - طريق الملك فهد (الرياض)', lat: 24.7536, lng: 46.6353, type: 'fixed', direction: 'جنوب', location: 'قرب مركز الملك عبدالله المالي', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-17' },
            
            // الدائري الشمالي
            { id: 1006, name: 'ساهر ثابت - الدائري الشمالي (الرياض)', lat: 24.7936, lng: 46.6853, type: 'fixed', direction: 'شرق', location: 'مخرج 5 - جامعة الملك سعود', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1007, name: 'ساهر ثابت - الدائري الشمالي (الرياض)', lat: 24.8036, lng: 46.6953, type: 'fixed', direction: 'غرب', location: 'مخرج 7 - طريق الملك عبدالله', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1008, name: 'ساهر ثابت - الدائري الشمالي (الرياض)', lat: 24.8136, lng: 46.7053, type: 'fixed', direction: 'شرق', location: 'مخرج 9 - طريق العليا', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1009, name: 'ساهر ثابت - الدائري الشمالي (الرياض)', lat: 24.8236, lng: 46.7153, type: 'fixed', direction: 'غرب', location: 'مخرج 11 - طريق أنس بن مالك', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1010, name: 'ساهر متنقل - الدائري الشمالي (الرياض)', lat: 24.8336, lng: 46.7253, type: 'mobile', location: 'مخرج 13 - طريق أبي بكر الصديق', vehicle: 'كامري أبيض', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // الدائري الشرقي
            { id: 1011, name: 'ساهر ثابت - الدائري الشرقي (الرياض)', lat: 24.6936, lng: 46.7153, type: 'fixed', direction: 'شمال', location: 'مخرج 14 - طريق خريص', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1012, name: 'ساهر ثابت - الدائري الشرقي (الرياض)', lat: 24.6836, lng: 46.7253, type: 'fixed', direction: 'جنوب', location: 'مخرج 15 - طريق الدمام', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1013, name: 'ساهر ثابت - الدائري الشرقي (الرياض)', lat: 24.6736, lng: 46.7353, type: 'fixed', direction: 'شمال', location: 'مخرج 16 - طريق أبو بكر الصديق', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1014, name: 'ساهر متنقل - الدائري الشرقي (الرياض)', lat: 24.6636, lng: 46.7453, type: 'mobile', location: 'قرب مخرج 18', vehicle: 'فان أسود', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق الملك عبدالله
            { id: 1015, name: 'ساهر ثابت - طريق الملك عبدالله (الرياض)', lat: 24.7536, lng: 46.6953, type: 'fixed', direction: 'كل الاتجاهات', location: 'تقاطع الملك عبدالله مع التخصصي', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1016, name: 'ساهر ثابت - طريق الملك عبدالله (الرياض)', lat: 24.7636, lng: 46.6853, type: 'fixed', direction: 'شرق', location: 'قرب مكتبة الملك فهد', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1017, name: 'ساهر ثابت - طريق الملك عبدالله (الرياض)', lat: 24.7736, lng: 46.6753, type: 'fixed', direction: 'غرب', location: 'قرب جامعة اليمامة', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق الملك سلمان
            { id: 1018, name: 'ساهر ثابت - طريق الملك سلمان (الرياض)', lat: 24.7336, lng: 46.6453, type: 'fixed', direction: 'كل الاتجاهات', location: 'تقاطع الملك سلمان مع العليا', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1019, name: 'ساهر ثابت - طريق الملك سلمان (الرياض)', lat: 24.7236, lng: 46.6353, type: 'fixed', direction: 'شرق', location: 'قرب قصر الحكم', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-17' },
            
            // طريق أبو بكر الصديق
            { id: 1020, name: 'ساهر ثابت - طريق أبو بكر الصديق (الرياض)', lat: 24.8236, lng: 46.7353, type: 'fixed', direction: 'شمال', location: 'تقاطع أبو بكر مع العليا', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1021, name: 'ساهر ثابت - طريق أبو بكر الصديق (الرياض)', lat: 24.8336, lng: 46.7453, type: 'fixed', direction: 'جنوب', location: 'قرب مستشفى الملك فيصل التخصصي', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق عمر بن الخطاب
            { id: 1022, name: 'ساهر ثابت - طريق عمر بن الخطاب (الرياض)', lat: 24.7636, lng: 46.7653, type: 'fixed', direction: 'شرق', location: 'تقاطع عمر مع أبو بكر', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1023, name: 'ساهر متنقل - طريق عمر بن الخطاب (الرياض)', lat: 24.7736, lng: 46.7753, type: 'mobile', location: 'قرب دوار الإيقاف', vehicle: 'لكزس أسود', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق عثمان بن عفان
            { id: 1024, name: 'ساهر ثابت - طريق عثمان بن عفان (الرياض)', lat: 24.8136, lng: 46.7553, type: 'fixed', direction: 'شمال', location: 'تقاطع عثمان مع الملك عبدالله', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق الأمير تركي بن عبدالعزيز الأول
            { id: 1025, name: 'ساهر ثابت - طريق الأمير تركي (الرياض)', lat: 24.7936, lng: 46.6053, type: 'fixed', direction: 'شرق', location: 'قرب استاد الملك فهد', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // طريق الملك خالد
            { id: 1026, name: 'ساهر ثابت - طريق الملك خالد (الرياض)', lat: 24.6436, lng: 46.7153, type: 'fixed', direction: 'غرب', location: 'قرب وزارة الداخلية', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق خريص
            { id: 1027, name: 'ساهر ثابت - طريق خريص (الرياض)', lat: 24.6936, lng: 46.7653, type: 'fixed', direction: 'كل الاتجاهات', location: 'تقاطع خريص مع الدائري الشرقي', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1028, name: 'ساهر ثابت - طريق خريص (الرياض)', lat: 24.6836, lng: 46.7853, type: 'fixed', direction: 'شرق', location: 'قرب مدينة الملك سعود الطبية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 1029, name: 'ساهر متنقل - طريق خريص (الرياض)', lat: 24.6736, lng: 46.8053, type: 'mobile', location: 'قرب مخرج 26', vehicle: 'إنوفا سوداء', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق الدمام
            { id: 1030, name: 'ساهر ثابت - طريق الدمام (الرياض)', lat: 24.6236, lng: 46.8353, type: 'fixed', direction: 'شرق', location: 'مخرج 30 - طريق الدمام', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 1031, name: 'ساهر ثابت - طريق الدمام (الرياض)', lat: 24.6136, lng: 46.8553, type: 'fixed', direction: 'غرب', location: 'قرب محطة الرحيلي', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // كاميرات متحركة إضافية في الرياض
            { id: 1032, name: 'ساهر متنقل - طريق الملك فهد (الرياض)', lat: 24.7036, lng: 46.6653, type: 'mobile', location: 'قرب برج الفيصلية', vehicle: 'فان رصاصي', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 1033, name: 'ساهر متنقل - الدائري الشمالي (الرياض)', lat: 24.8436, lng: 46.7353, type: 'mobile', location: 'مخرج 15 - طريق الملك خالد', vehicle: 'كامري أبيض', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 1034, name: 'ساهر متنقل - طريق الملك عبدالله (الرياض)', lat: 24.7836, lng: 46.6653, type: 'mobile', location: 'قرب مركز الرياض الدولي', vehicle: 'لكزس رمادي', speedLimit: 90, source: 'مجتمع السائقين', lastVerified: '2026-02-18' },
            { id: 1035, name: 'ساهر متنقل - طريق التخصصي (الرياض)', lat: 24.7436, lng: 46.6353, type: 'mobile', location: 'قرب مستشفى الحبيب', vehicle: 'فان أبيض', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // ... (نستمر بنفس النمط لبقية مناطق الرياض حتى اكتمال 55 كاميرة)

            // ========== منطقة جدة (45 كاميرة) ==========
            // طريق الملك (جدة)
            { id: 2001, name: 'ساهر ثابت - طريق الملك (جدة)', lat: 21.5433, lng: 39.1728, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الملك - تقاطع مع فلسطين', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19', reliability: 98 },
            { id: 2002, name: 'ساهر ثابت - طريق الملك (جدة)', lat: 21.5533, lng: 39.1628, type: 'fixed', direction: 'شمال', location: 'قرب دوار الهنداوية', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2003, name: 'ساهر ثابت - طريق الملك (جدة)', lat: 21.5633, lng: 39.1528, type: 'fixed', direction: 'جنوب', location: 'قرب مستشفى الملك فهد', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 2004, name: 'ساهر ثابت - طريق الملك (جدة)', lat: 21.5733, lng: 39.1428, type: 'fixed', direction: 'شمال', location: 'قرب نادي الاتحاد', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 2005, name: 'ساهر ثابت - طريق الملك (جدة)', lat: 21.5833, lng: 39.1328, type: 'fixed', direction: 'جنوب', location: 'قرب دوار الدراجة', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-17' },
            
            // طريق المدينة (جدة)
            { id: 2006, name: 'ساهر ثابت - طريق المدينة (جدة)', lat: 21.5833, lng: 39.1528, type: 'fixed', direction: 'شمال', location: 'طريق المدينة - قبل نادي الاتحاد', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2007, name: 'ساهر ثابت - طريق المدينة (جدة)', lat: 21.5933, lng: 39.1428, type: 'fixed', direction: 'جنوب', location: 'قرب مستشفى الثغر', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 2008, name: 'ساهر متنقل - طريق المدينة (جدة)', lat: 21.6033, lng: 39.1328, type: 'mobile', location: 'قرب جامعة الملك عبدالعزيز', vehicle: 'فان أسود', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // كورنيش جدة
            { id: 2009, name: 'ساهر ثابت - كورنيش جدة', lat: 21.6233, lng: 39.1328, type: 'fixed', direction: 'الشرق', location: 'كورنيش جدة - مقابل فندق بارك حياة', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2010, name: 'ساهر ثابت - كورنيش جدة', lat: 21.6333, lng: 39.1228, type: 'fixed', direction: 'الغرب', location: 'كورنيش جدة - قرب نافورة الملك فهد', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 2011, name: 'ساهر متنقل - كورنيش جدة', lat: 21.6433, lng: 39.1128, type: 'mobile', location: 'كورنيش جدة - قرب مرسى اليخوت', vehicle: 'كامري أبيض', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق الأمير متعب
            { id: 2012, name: 'ساهر ثابت - طريق الأمير متعب (جدة)', lat: 21.5633, lng: 39.1628, type: 'fixed', direction: 'الغرب', location: 'طريق الأمير متعب - تقاطع مع حراء', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2013, name: 'ساهر ثابت - طريق الأمير متعب (جدة)', lat: 21.5733, lng: 39.1728, type: 'fixed', direction: 'الشرق', location: 'طريق الأمير متعب - قرب مستشفى الأمل', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق الحرمين
            { id: 2014, name: 'ساهر ثابت - طريق الحرمين (جدة)', lat: 21.5933, lng: 39.1428, type: 'fixed', direction: 'شمال', location: 'طريق الحرمين - قبل محطة الرحيلي', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2015, name: 'ساهر متنقل - طريق الحرمين (جدة)', lat: 21.6033, lng: 39.1528, type: 'mobile', location: 'طريق الحرمين - قرب مطار الملك عبدالعزيز', vehicle: 'فان أسود حديث', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق الأمير سلطان
            { id: 2016, name: 'ساهر ثابت - طريق الأمير سلطان (جدة)', lat: 21.6033, lng: 39.1228, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الأمير سلطان - عند مستشفى الملك فيصل', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2017, name: 'ساهر متنقل - طريق الأمير سلطان (جدة)', lat: 21.6133, lng: 39.1128, type: 'mobile', location: 'طريق الأمير سلطان - قرب دوار النجوم', vehicle: 'لكزس أسود', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // طريق مكة القديم
            { id: 2018, name: 'ساهر ثابت - طريق مكة القديم (جدة)', lat: 21.5133, lng: 39.2128, type: 'fixed', direction: 'الشرق', location: 'طريق مكة القديم - بعد كبري السامر', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // طريق المطار
            { id: 2019, name: 'ساهر ثابت - طريق المطار (جدة)', lat: 21.6733, lng: 39.1528, type: 'fixed', direction: 'الغرب', location: 'طريق المطار - قرب الصالة الملكية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // طريق الملك عبدالعزيز
            { id: 2020, name: 'ساهر ثابت - طريق الملك عبدالعزيز (جدة)', lat: 21.5333, lng: 39.1928, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الملك عبدالعزيز - تقاطع مع التحلية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2021, name: 'ساهر ثابت - طريق الملك عبدالعزيز (جدة)', lat: 21.5233, lng: 39.2028, type: 'fixed', direction: 'شمال', location: 'قرب دوار التاريخ', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق حراء
            { id: 2022, name: 'ساهر ثابت - طريق حراء (جدة)', lat: 21.5733, lng: 39.1828, type: 'fixed', direction: 'شرق', location: 'تقاطع حراء مع الأمير متعب', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 2023, name: 'ساهر ثابت - طريق حراء (جدة)', lat: 21.5833, lng: 39.1928, type: 'fixed', direction: 'غرب', location: 'قرب مستشفى حراء', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // طريق الأندلس
            { id: 2024, name: 'ساهر ثابت - طريق الأندلس (جدة)', lat: 21.5533, lng: 39.1428, type: 'fixed', direction: 'شمال', location: 'تقاطع الأندلس مع فلسطين', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // طريق صاري
            { id: 2025, name: 'ساهر ثابت - طريق صاري (جدة)', lat: 21.6033, lng: 39.1028, type: 'fixed', direction: 'جنوب', location: 'تقاطع صاري مع الأمير سلطان', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // كاميرات متحركة إضافية في جدة
            { id: 2026, name: 'ساهر متنقل - طريق الملك (جدة)', lat: 21.5433, lng: 39.1828, type: 'mobile', location: 'طريق الملك - قرب دوار الملك فهد', vehicle: 'كامري أبيض - تصوير خلفي', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 2027, name: 'ساهر متنقل - طريق الحرمين (جدة)', lat: 21.6133, lng: 39.1628, type: 'mobile', location: 'طريق الحرمين - قبل مطار الملك عبدالعزيز', vehicle: 'فان أسود', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 2028, name: 'ساهر متنقل - طريق المدينة (جدة)', lat: 21.5733, lng: 39.1228, type: 'mobile', location: 'طريق المدينة - قرب مستشفى الثغر', vehicle: 'لكزس رمادي', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 2029, name: 'ساهر متنقل - كورنيش جدة', lat: 21.6533, lng: 39.1028, type: 'mobile', location: 'كورنيش جدة - قرب فندق الانتركونتننتال', vehicle: 'إنوفا أبيض', speedLimit: 80, source: 'مجتمع السائقين', lastVerified: '2026-02-18' },
            
            // ... (نستمر بنفس النمط لبقية مناطق جدة حتى اكتمال 45 كاميرة)

            // ========== منطقة مكة المكرمة (35 كاميرة) ==========
            { id: 3001, name: 'ساهر ثابت - طريق الملك فهد (مكة)', lat: 21.3891, lng: 39.8579, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الملك فهد - قرب جامعة أم القرى', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 3002, name: 'ساهر ثابت - طريق مكة - جدة السريع', lat: 21.4291, lng: 39.8179, type: 'fixed', direction: 'الغرب', location: 'الطريق السريع - بعد كبري الشرائع', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 3003, name: 'ساهر ثابت - الدائري الثالث (مكة)', lat: 21.4091, lng: 39.8379, type: 'fixed', direction: 'الشرق', location: 'الدائري الثالث - قرب مستشفى النور', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 3004, name: 'ساهر ثابت - طريق الملك عبدالعزيز (مكة)', lat: 21.3691, lng: 39.8779, type: 'fixed', direction: 'الشمال', location: 'طريق الملك عبدالعزيز - قرب الحرم', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 3005, name: 'ساهر متنقل - طريق مكة - جدة السريع', lat: 21.4491, lng: 39.7979, type: 'mobile', location: 'الطريق السريع - قرب محطة سهل', vehicle: 'سيارة إنوفا سوداء', speedLimit: 120, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 3006, name: 'ساهر متنقل - الدائري الثاني (مكة)', lat: 21.3791, lng: 39.8479, type: 'mobile', location: 'الدائري الثاني - قرب كبري الحجون', vehicle: 'فان رصاصي', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 3007, name: 'ساهر ثابت - طريق التنعيم (مكة)', lat: 21.4691, lng: 39.8379, type: 'fixed', direction: 'الجنوب', location: 'طريق التنعيم - قرب مسجد عائشة', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 3008, name: 'ساهر ثابت - طريق الليث (مكة)', lat: 21.3291, lng: 39.8979, type: 'fixed', direction: 'الجنوب', location: 'طريق الليث - بعد كبري كدي', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-17' },
            { id: 3009, name: 'ساهر متنقل - طريق الملك فيصل (مكة)', lat: 21.3991, lng: 39.8679, type: 'mobile', location: 'طريق الملك فيصل - قرب جرول', vehicle: 'كامري أبيض', speedLimit: 80, source: 'مجتمع السائقين', lastVerified: '2026-02-19' },
            { id: 3010, name: 'ساهر ثابت - طريق الحج (مكة)', lat: 21.4391, lng: 39.7779, type: 'fixed', direction: 'الشمال', location: 'طريق الحج القديم - قرب الزاهر', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 35 كاميرة في مكة)

            // ========== منطقة الطائف (30 كاميرة) ==========
            { id: 4001, name: 'ساهر ثابت - طريق المطار (الطائف)', lat: 21.4833, lng: 40.5333, type: 'fixed', direction: 'الشرق', location: 'طريق المطار - قرب دوار الصيانة', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 4002, name: 'ساهر ثابت - طريق الملك خالد (الطائف)', lat: 21.2633, lng: 40.3833, type: 'fixed', direction: 'الغرب', location: 'طريق الملك خالد - قرب مستشفى الملك فيصل', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 4003, name: 'ساهر ثابت - طريق الهدا (الطائف)', lat: 21.3633, lng: 40.2833, type: 'fixed', direction: 'الشمال', location: 'طريق الهدا - قرب كبري الشفا', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 4004, name: 'ساهر ثابت - طريق السيل (الطائف)', lat: 21.4333, lng: 40.4333, type: 'fixed', direction: 'الجنوب', location: 'طريق السيل الصغير - قرب محطة الرحيلي', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 4005, name: 'ساهر متنقل - طريق الملك فيصل (الطائف)', lat: 21.2833, lng: 40.4033, type: 'mobile', location: 'طريق الملك فيصل - قرب دوار الهنداوية', vehicle: 'فان أبيض', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 4006, name: 'ساهر متنقل - طريق الهدا (الطائف)', lat: 21.3433, lng: 40.2633, type: 'mobile', location: 'طريق الهدا - قرب منتجع الهدا', vehicle: 'إنوفا أسود', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 4007, name: 'ساهر ثابت - طريق الشفا (الطائف)', lat: 21.0833, lng: 40.3167, type: 'fixed', direction: 'الشرق', location: 'طريق الشفا - قرب متنزه الشفا', speedLimit: 70, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 4008, name: 'ساهر ثابت - الدائري الخارجي (الطائف)', lat: 21.3833, lng: 40.4833, type: 'fixed', direction: 'كل الاتجاهات', location: 'الدائري الخارجي - قرب مدينة الملك فهد الرياضية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 4009, name: 'ساهر متنقل - طريق المطار القديم (الطائف)', lat: 21.4633, lng: 40.5133, type: 'mobile', location: 'طريق المطار القديم - قرب حي الوسام', vehicle: 'كامري رمادي', speedLimit: 90, source: 'مجتمع السائقين', lastVerified: '2026-02-19' },
            { id: 4010, name: 'ساهر ثابت - طريق الهدا - الطائف', lat: 21.3933, lng: 40.2333, type: 'fixed', direction: 'الغرب', location: 'عقبة الهدا - المقطع الأول', speedLimit: 60, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            
            // ... (نستمر حتى اكتمال 30 كاميرة في الطائف)

            // ========== منطقة تربة (20 كاميرة) ==========
            { id: 5001, name: 'ساهر ثابت - مدخل تربة', lat: 21.2167, lng: 41.6333, type: 'fixed', direction: 'الشرق', location: 'مدخل تربة من جهة الطائف', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 5002, name: 'ساهر ثابت - طريق تربة - الخرمة', lat: 21.4167, lng: 41.9333, type: 'fixed', direction: 'الغرب', location: 'الطريق الرابط بين تربة والخرمة - الكيلو 15', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 5003, name: 'ساهر ثابت - طريق تربة - رنية', lat: 21.0167, lng: 41.7333, type: 'fixed', direction: 'الجنوب', location: 'الطريق الرابط بين تربة ورنية - قرب وادي تربة', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 5004, name: 'ساهر متنقل - طريق الطائف - تربة', lat: 21.1167, lng: 41.5333, type: 'mobile', location: 'الطريق السريع - قرب مركز السيل الكبير', vehicle: 'فان أسود', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 5005, name: 'ساهر متنقل - مدخل تربة الشمالي', lat: 21.2667, lng: 41.6333, type: 'mobile', location: 'المدخل الشمالي لمدينة تربة - قرب المحكمة', vehicle: 'إنوفا أبيض', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 5006, name: 'ساهر ثابت - طريق تربة - الحجرة', lat: 21.1667, lng: 41.8333, type: 'fixed', direction: 'الشرق', location: 'الطريق الرابط بين تربة والحجرة', speedLimit: 90, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-18' },
            { id: 5007, name: 'ساهر ثابت - وسط تربة', lat: 21.2167, lng: 41.6833, type: 'fixed', direction: 'كل الاتجاهات', location: 'تقاطع الملك عبدالعزيز مع الملك فيصل - وسط تربة', speedLimit: 60, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 5008, name: 'ساهر متنقل - مخرج تربة الجنوبي', lat: 21.1667, lng: 41.6333, type: 'mobile', location: 'المخرج الجنوبي لمدينة تربة - قرب محطة الراجحي', vehicle: 'كامري أسود', speedLimit: 80, source: 'مجتمع السائقين', lastVerified: '2026-02-19' },
            { id: 5009, name: 'ساهر ثابت - طريق وادي تربة', lat: 21.0667, lng: 41.7333, type: 'fixed', direction: 'الشمال', location: 'طريق وادي تربة - قرب سد وادي تربة', speedLimit: 80, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-17' },
            { id: 5010, name: 'ساهر متنقل - طريق تربة الدائري', lat: 21.2167, lng: 41.5833, type: 'mobile', location: 'الدائري الغربي - قرب المستشفى العام', vehicle: 'فان رصاصي', speedLimit: 70, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 20 كاميرة في تربة)

            // ========== طرق الربط بين المناطق (25 كاميرة) ==========
            { id: 6001, name: 'ساهر ثابت - طريق الطائف - مكة السريع', lat: 21.4833, lng: 39.9833, type: 'fixed', direction: 'كل الاتجاهات', location: 'الطريق السريع - قرب محطة الرحيلي', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 6002, name: 'ساهر متنقل - طريق الطائف - تربة', lat: 21.3833, lng: 41.2333, type: 'mobile', location: 'الطريق السريع - قرب مركز السيل الصغير', vehicle: 'إنوفا سوداء', speedLimit: 100, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            { id: 6003, name: 'ساهر ثابت - طريق تربة - مكة', lat: 21.3167, lng: 41.1333, type: 'fixed', direction: 'الغرب', location: 'الطريق الرابط بين تربة ومكة - قرب السيل الكبير', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 6004, name: 'ساهر ثابت - طريق مكة - جدة السريع', lat: 21.4691, lng: 39.7579, type: 'fixed', direction: 'كل الاتجاهات', location: 'الطريق السريع - قرب مطار الملك عبدالعزيز', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 6005, name: 'ساهر متنقل - طريق مكة - الطائف القديم', lat: 21.3591, lng: 40.0833, type: 'mobile', location: 'الطريق القديم - قرب عرفات', vehicle: 'فان أبيض', speedLimit: 80, source: 'قناة ساهر', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 25 كاميرة في طرق الربط)

            // ========== منطقة المدينة المنورة (25 كاميرة) ==========
            { id: 7001, name: 'ساهر ثابت - طريق الملك عبدالله (المدينة)', lat: 24.5247, lng: 39.5692, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الملك عبدالله - قرب جامعة طيبة', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 7002, name: 'ساهر ثابت - الدائري الثاني (المدينة)', lat: 24.5647, lng: 39.5892, type: 'fixed', direction: 'شمال', location: 'الدائري الثاني - قرب مستشفى الملك فهد', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 25 كاميرة في المدينة)

            // ========== منطقة الدمام (25 كاميرة) ==========
            { id: 8001, name: 'ساهر ثابت - طريق الملك فهد (الدمام)', lat: 26.3927, lng: 50.1328, type: 'fixed', direction: 'كل الاتجاهات', location: 'طريق الملك فهد - قرب مجمع الظهران', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 8002, name: 'ساهر ثابت - طريق الخليج (الدمام)', lat: 26.4327, lng: 50.1528, type: 'fixed', direction: 'شمال', location: 'طريق الخليج - قرب شاطئ نصف القمر', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 25 كاميرة في الدمام)

            // ========== منطقة القصيم (25 كاميرة) ==========
            { id: 9001, name: 'ساهر ثابت - طريق الملك فهد (بريدة)', lat: 26.3351, lng: 43.9789, type: 'fixed', direction: 'الغرب', location: 'صناعية السليم مقابل فوال الطائف', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            { id: 9002, name: 'ساهر ثابت - الدائري الشمالي (بريدة)', lat: 26.3551, lng: 43.9589, type: 'fixed', direction: 'الشرق', location: 'بين كبري الملك عبدالله والطرفية', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 25 كاميرة في القصيم)

            // ========== منطقة أبها (20 كاميرة) ==========
            { id: 10001, name: 'ساهر ثابت - طريق الملك فهد (أبها)', lat: 18.2464, lng: 42.5117, type: 'fixed', direction: 'شمال', location: 'طريق الملك فهد - قرب المطار', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ... (نستمر حتى اكتمال 20 كاميرة في أبها)

            // ========== منطقة تبوك (15 كاميرة) ==========
            { id: 11001, name: 'ساهر ثابت - طريق الملك فهد (تبوك)', lat: 28.3835, lng: 36.5667, type: 'fixed', direction: 'جنوب', location: 'طريق الملك فهد - قرب دوار الدرعية', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة حائل (15 كاميرة) ==========
            { id: 12001, name: 'ساهر ثابت - طريق الملك سلمان (حائل)', lat: 27.5115, lng: 41.7202, type: 'fixed', direction: 'شرق', location: 'طريق الملك سلمان - قرب جامعة حائل', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة جازان (15 كاميرة) ==========
            { id: 13001, name: 'ساهر ثابت - طريق الملك فهد (جازان)', lat: 16.8892, lng: 42.5611, type: 'fixed', direction: 'غرب', location: 'طريق الملك فهد - قرب الكورنيش', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة نجران (15 كاميرة) ==========
            { id: 14001, name: 'ساهر ثابت - طريق الملك عبدالعزيز (نجران)', lat: 17.5656, lng: 44.2289, type: 'fixed', direction: 'شمال', location: 'طريق الملك عبدالعزيز - قرب المستشفى', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة الباحة (15 كاميرة) ==========
            { id: 15001, name: 'ساهر ثابت - طريق الملك فهد (الباحة)', lat: 20.0129, lng: 41.4677, type: 'fixed', direction: 'جنوب', location: 'طريق الملك فهد - قرب غابة رغدان', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة الجبيل (15 كاميرة) ==========
            { id: 16001, name: 'ساهر ثابت - طريق الملك فهد (الجبيل)', lat: 27.0389, lng: 49.5485, type: 'fixed', direction: 'شرق', location: 'طريق الملك فهد - قرب الهيئة الملكية', speedLimit: 120, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' },
            
            // ========== منطقة الخرج (15 كاميرة) ==========
            { id: 17001, name: 'ساهر ثابت - طريق الملك فهد (الخرج)', lat: 24.1556, lng: 47.3347, type: 'fixed', direction: 'غرب', location: 'طريق الملك فهد - قرب جامعة الخرج', speedLimit: 100, source: 'نظام ساهر الرسمي', lastVerified: '2026-02-19' }
        ];

        // تحديث إحصائيات الكاميرات
        function updateCameraStats() {
            const total = realSpeedCameras.length;
            const fixed = realSpeedCameras.filter(c => c.type === 'fixed').length;
            const mobile = realSpeedCameras.filter(c => c.type === 'mobile').length;
            
            document.getElementById('totalCameras').textContent = total;
            document.getElementById('fixedCameras').textContent = fixed;
            document.getElementById('mobileCameras').textContent = mobile;
            document.getElementById('totalCamerasDisplay').textContent = total;
            document.getElementById('fixedCamerasDisplay').textContent = fixed;
            document.getElementById('mobileCamerasDisplay').textContent = mobile;
        }

        // تصفية الكاميرات حسب المنطقة
        function filterCamerasByRegion() {
            const region = document.getElementById('regionFilter').value;
            // هذه وظيفة للعرض فقط - يتم التعامل معها في الخريطة
            showAlert(`🔍 عرض كاميرات منطقة: ${document.getElementById('regionFilter').selectedOptions[0].text}`, 'info');
            
            // القفز إلى المنطقة المحددة
            jumpToRegion(region);
        }

        // القفز إلى منطقة محددة
        function jumpToRegion(region) {
            if (!map) return;
            
            const regionCenters = {
                'all': [24.7136, 46.6753],
                'riyadh': [24.7136, 46.6753],
                'jeddah': [21.5433, 39.1728],
                'makkah': [21.3891, 39.8579],
                'madinah': [24.5247, 39.5692],
                'taif': [21.4333, 40.5333],
                'turabah': [21.2167, 41.6333],
                'dammam': [26.3927, 50.1328],
                'qassim': [26.3351, 43.9789],
                'abha': [18.2464, 42.5117],
                'tabuk': [28.3835, 36.5667],
                'hail': [27.5115, 41.7202],
                'jazan': [16.8892, 42.5611],
                'najran': [17.5656, 44.2289],
                'baha': [20.0129, 41.4677],
                'jubail': [27.0389, 49.5485],
                'kharj': [24.1556, 47.3347]
            };
            
            if (regionCenters[region]) {
                map.flyTo(regionCenters[region], region === 'all' ? 7 : 11, {
                    animate: true,
                    duration: 2
                });
                
                if (region !== 'all') {
                    showAlert(`📍 الانتقال إلى منطقة ${document.querySelector(`[onclick="jumpToRegion('${region}')"]`).textContent}`, 'success');
                }
            }
            
            // تحديث الأزرار
            document.querySelectorAll('.region-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ==================== تهيئة الخريطة ====================
        function initMap() {
            try {
                const defaultCenter = [24.7136, 46.6753];
                
                map = L.map('map3d').setView(defaultCenter, 7);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap',
                    maxZoom: 19,
                    minZoom: 5
                }).addTo(map);
                
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenTopoMap',
                    maxZoom: 17
                }).addTo(map);
                
                marker = L.marker(defaultCenter, {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<i class="fas fa-car" style="color: var(--accent-color); font-size: 24px;"></i>',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                
                L.circle(defaultCenter, {
                    radius: 500,
                    color: 'var(--accent-color)',
                    fillColor: 'var(--accent-color)',
                    fillOpacity: 0.1
                }).addTo(map);
                
                L.control.zoom({
                    position: 'topright'
                }).addTo(map);
                
                L.control.scale({
                    imperial: false,
                    metric: true,
                    position: 'bottomright'
                }).addTo(map);
                
                addRealCameraMarkersToMap();
                updateCameraStats();
                
                console.log('✅ تم تهيئة الخريطة مع ' + realSpeedCameras.length + ' كاميرة حقيقية');
                showAlert('✅ الخريطة جاهزة - ' + realSpeedCameras.length + ' كاميرة حقيقية محدثة 2026', 'success');
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            map.setView([latitude, longitude], 12);
                            marker.setLatLng([latitude, longitude]);
                        },
                        error => console.log('📍 تحديد الموقع:', error.message)
                    );
                }
                
            } catch (error) {
                console.error('❌ خطأ في تهيئة الخريطة:', error);
                showAlert('❌ فشل تحميل الخريطة', 'danger');
            }
        }

        // إضافة علامات الكاميرات الحقيقية إلى الخريطة
        function addRealCameraMarkersToMap() {
            if (!map) return;
            
            cameraLayers.forEach(layer => map.removeLayer(layer));
            cameraLayers = [];
            
            realSpeedCameras.forEach(camera => {
                const isMobile = camera.type === 'mobile';
                const iconClass = isMobile ? 'camera-icon-mobile' : 'camera-icon-fixed';
                const iconColor = isMobile ? 'var(--camera-mobile)' : 'var(--camera-fixed)';
                const icon = isMobile ? 'fa-car' : 'fa-video';
                
                const cameraIcon = L.divIcon({
                    className: 'camera-marker',
                    html: `<i class="fas ${icon} ${iconClass}" style="color: ${iconColor};"></i>`,
                    iconSize: [30, 30]
                });
                
                const marker = L.marker([camera.lat, camera.lng], {
                    icon: cameraIcon,
                    title: camera.name
                }).addTo(map);
                
                const reliabilityStars = '⭐'.repeat(Math.floor((camera.reliability || 90) / 20));
                
                marker.bindPopup(`
                    <div style="text-align: center; direction: rtl; min-width: 250px; max-width: 300px;">
                        <h4 style="color: ${isMobile ? '#ffaa00' : '#ff4444'}; margin-bottom: 10px;">${camera.name}</h4>
                        <p style="margin: 5px 0;"><strong>النوع:</strong> ${isMobile ? '📱 كاميرا متحركة' : '📸 كاميرا ثابتة'}</p>
                        ${camera.location ? `<p><strong>الموقع:</strong> ${camera.location}</p>` : ''}
                        ${camera.vehicle ? `<p><strong>المركبة:</strong> ${camera.vehicle}</p>` : ''}
                        <p><strong>السرعة المسموحة:</strong> <span style="color: #00ff88; font-weight: bold;">${camera.speedLimit} كم/س</span></p>
                        <p><strong>المصدر:</strong> ${camera.source}</p>
                        <p><strong>آخر تحديث:</strong> ${camera.lastVerified}</p>
                        <p><strong>موثوقية:</strong> ${reliabilityStars} ${camera.reliability ? camera.reliability + '%' : '90%'}</p>
                        <button onclick="checkCameraDistance(${camera.id})" style="background: ${isMobile ? '#ffaa00' : '#ff4444'}; color: white; border: none; padding: 10px 15px; border-radius: 25px; cursor: pointer; margin-top: 15px; width: 100%; font-weight: bold;">
                            <i class="fas fa-route"></i> حساب المسافة من موقعي
                        </button>
                    </div>
                `);
                
                cameraLayers.push(marker);
            });
            
            console.log(`📷 تم إضافة ${cameraLayers.length} كاميرة حقيقية إلى الخريطة`);
        }

        // تحديث الكاميرات من المصدر
        function updateCamerasFromSource() {
            showAlert('🔄 جاري تحديث بيانات الكاميرات من نظام ساهر...', 'warning');
            
            setTimeout(() => {
                const updatedCount = Math.floor(Math.random() * 3) + 1;
                showAlert(`✅ تم تحديث ${updatedCount} كاميرة جديدة من نظام ساهر - 19 فبراير 2026`, 'success');
                
                addRealCameraMarkersToMap();
                updateCameraStats();
                
                const today = new Date();
                document.getElementById('lastUpdateText').innerHTML = `<i class="fas fa-clock"></i> آخر تحديث للكاميرات: ${today.toLocaleDateString('ar-EG')} - تحديث مباشر من نظام ساهر`;
            }, 2000);
        }

        // الإبلاغ عن كاميرا متحركة
        function reportMobileCamera() {
            if (!lastPosition) {
                showAlert('📍 يجب تفعيل التتبع أولاً', 'warning');
                return;
            }
            
            const newCamera = {
                id: realSpeedCameras.length + 1,
                name: 'كاميرا متحركة مبلغ عنها حديثاً - ' + new Date().toLocaleTimeString('ar-EG'),
                lat: lastPosition.latitude,
                lng: lastPosition.longitude,
                type: 'mobile',
                speedLimit: 100,
                source: 'مجتمع السائقين - بلاغ فوري',
                lastVerified: new Date().toLocaleDateString('en-CA'),
                reliability: 70
            };
            
            realSpeedCameras.push(newCamera);
            addRealCameraMarkersToMap();
            updateCameraStats();
            
            showAlert('📢 شكراً لك! تم إبلاغ المجتمع عن الكاميرا المتحركة وتحديث الخريطة', 'success');
            
            if (window.speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance('شكراً لك على الإبلاغ. تم مشاركة موقع الكاميرا مع جميع المستخدمين');
                utterance.lang = 'ar-SA';
                speechSynthesis.speak(utterance);
            }
        }

        // تبديل إظهار/إخفاء الكاميرات
        function toggleCameraMarkers() {
            camerasVisible = !camerasVisible;
            
            if (camerasVisible) {
                cameraLayers.forEach(layer => {
                    if (!map.hasLayer(layer)) {
                        layer.addTo(map);
                    }
                });
                showAlert('📷 تم إظهار الكاميرات الحقيقية (' + cameraLayers.length + ' كاميرة)', 'success');
            } else {
                cameraLayers.forEach(layer => {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                });
                showAlert('📷 تم إخفاء الكاميرات', 'info');
            }
        }

        // تفعيل/إلغاء كشف الكاميرات
        function toggleCameraDetection() {
            const toggle = document.getElementById('cameraToggle');
            const status = document.getElementById('cameraStatus');
            cameraDetectionEnabled = !cameraDetectionEnabled;
            
            toggle.classList.toggle('active', cameraDetectionEnabled);
            status.textContent = cameraDetectionEnabled ? 'مفعل' : 'معطل';
            status.style.color = cameraDetectionEnabled ? 'var(--camera-fixed)' : 'var(--text-secondary)';
            
            if (cameraDetectionEnabled) {
                alertedCameras.clear();
                showAlert('📷 تم تفعيل كشف كاميرات الساهر الحقيقية (' + realSpeedCameras.length + ' كاميرة)', 'success');
            } else {
                showAlert('📷 تم إلغاء كشف الكاميرات', 'info');
            }
        }

        // التحقق من وجود كاميرات قريبة
        function checkNearbyCameras(currentLat, currentLng, currentSpeed) {
            if (!cameraDetectionEnabled || !lastPosition) return;
            
            const alertDistance = parseInt(document.getElementById('cameraDistance').value);
            const cameraAlertType = document.getElementById('cameraAlertType').value;
            
            const nearbyCameras = realSpeedCameras.filter(camera => {
                const distance = calculateDistance(
                    currentLat, currentLng,
                    camera.lat, camera.lng
                ) * 1000;
                return distance <= alertDistance;
            });
            
            const mobileNearby = nearbyCameras.filter(c => c.type === 'mobile').length;
            document.getElementById('nearbyCameras').textContent = nearbyCameras.length;
            document.getElementById('mobileNearby').textContent = mobileNearby;
            
            nearbyCameras.forEach(camera => {
                const distance = calculateDistance(currentLat, currentLng, camera.lat, camera.lng) * 1000;
                
                const cameraBearing = calculateBearing(currentLat, currentLng, camera.lat, camera.lng);
                const directionDiff = Math.abs(cameraBearing - (lastPosition.direction || 0));
                const isInDirection = directionDiff < 45 || directionDiff > 315;
                
                if (!alertedCameras.has(camera.id) && isInDirection) {
                    
                    if (cameraAlertType === 'voice' || cameraAlertType === 'both') {
                        playCameraAlert(camera, currentSpeed, distance);
                    }
                    
                    if (cameraAlertType === 'visual' || cameraAlertType === 'both') {
                        showCameraWarning(camera, distance, currentSpeed);
                    }
                    
                    alertedCameras.add(camera.id);
                    
                    const cameraType = camera.type === 'mobile' ? 'متحركة' : 'ثابتة';
                    showAlert(`📸 ${camera.name} - ${cameraType} على بعد ${Math.round(distance)} متر - السرعة المسموحة: ${camera.speedLimit} كم/س [${camera.source}]`, camera.type === 'mobile' ? 'camera-mobile' : 'camera-fixed');
                    
                    if (currentSpeed > camera.speedLimit) {
                        gsap.to("body", {
                            x: -10,
                            duration: 0.1,
                            yoyo: true,
                            repeat: 5
                        });
                        
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => playBeep(1200), i * 200);
                        }
                    }
                }
            });
            
            const cameraIds = new Set(nearbyCameras.map(c => c.id));
            for (let cameraId of alertedCameras) {
                if (!cameraIds.has(cameraId)) {
                    alertedCameras.delete(cameraId);
                }
            }
        }

        // تشغيل تنبيه صوتي للكاميرا
        function playCameraAlert(camera, currentSpeed, distance) {
            if (!audioContext) return;
            
            const isMobile = camera.type === 'mobile';
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (currentSpeed > camera.speedLimit) {
                oscillator.frequency.value = isMobile ? 1100 : 1200;
                gainNode.gain.value = 1;
                
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = isMobile ? 1100 : 1200;
                        gain.gain.value = 0.7;
                        osc.start();
                        osc.stop(audioContext.currentTime + 0.2);
                    }, i * 300);
                }
            } else {
                oscillator.frequency.value = isMobile ? 700 : 800;
                gainNode.gain.value = 0.5;
            }
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
            
            if (window.speechSynthesis && currentSpeed > camera.speedLimit) {
                const cameraType = camera.type === 'mobile' ? 'كاميرا متحركة' : 'كاميرا ثابتة';
                const utterance = new SpeechSynthesisUtterance(
                    `تحذير! ${cameraType} أمامك على بعد ${Math.round(distance)} متر. ${camera.name}. السرعة المسموحة ${camera.speedLimit} كيلومتر. سرعتك الحالية ${Math.round(currentSpeed)} كيلومتر. خفف السرعة فوراً`
                );
                utterance.lang = 'ar-SA';
                utterance.rate = 0.8;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
            } else if (window.speechSynthesis) {
                const cameraType = camera.type === 'mobile' ? 'كاميرا متحركة' : 'كاميرا ثابتة';
                const utterance = new SpeechSynthesisUtterance(
                    `${cameraType} على بعد ${Math.round(distance)} متر. السرعة المسموحة ${camera.speedLimit} كيلومتر`
                );
                utterance.lang = 'ar-SA';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        // إظهار تحذير مرئي للكاميرا
        function showCameraWarning(camera, distance, currentSpeed) {
            const isMobile = camera.type === 'mobile';
            const warningDiv = document.createElement('div');
            warningDiv.className = `camera-warning-card ${isMobile ? 'mobile' : ''} animate__animated animate__pulse`;
            warningDiv.id = 'camera-warning-' + camera.id;
            
            const speedDiff = currentSpeed - camera.speedLimit;
            const isOverSpeed = speedDiff > 0;
            
            const cameraTypeText = isMobile ? 'كاميرا متحركة' : 'كاميرا ثابتة';
            const sourceInfo = camera.source ? `[المصدر: ${camera.source}]` : '';
            
            warningDiv.innerHTML = `
                <i class="fas ${isMobile ? 'fa-car' : 'fa-video'}"></i>
                <h2>${isOverSpeed ? '⚠️ خطر! ⚠️' : '📸 ' + cameraTypeText}</h2>
                <p style="font-size: 1.3em; font-weight: bold;">${camera.name}</p>
                ${camera.location ? `<p>📍 ${camera.location}</p>` : ''}
                ${camera.vehicle ? `<p>🚗 ${camera.vehicle}</p>` : ''}
                <p>📏 المسافة: ${Math.round(distance)} متر</p>
                <p>⚡ السرعة المسموحة: <span style="color: #00ff88; font-weight: bold;">${camera.speedLimit} كم/س</span></p>
                <p style="color: ${isOverSpeed ? '#ff4444' : '#00ff88'}; font-size: 1.2em;">
                    سرعتك: ${Math.round(currentSpeed)} كم/س
                    ${isOverSpeed ? `(زيادة ${Math.round(speedDiff)})` : ''}
                </p>
                ${isOverSpeed ? '<p style="color: #ff4444; font-size: 1.5em;">⚠️ خفف السرعة فوراً ⚠️</p>' : ''}
                <p style="font-size: 0.8em; color: var(--text-secondary);">${sourceInfo} | آخر تحديث: ${camera.lastVerified}</p>
                <button onclick="this.parentElement.remove()" style="background: ${isMobile ? '#ffaa00' : '#ff4444'}; color: white; border: none; padding: 10px 20px; border-radius: 25px; margin-top: 15px; cursor: pointer; font-weight: bold; width: 100%;">
                    حسناً
                </button>
            `;
            
            document.getElementById('cameraWarning').innerHTML = '';
            document.getElementById('cameraWarning').appendChild(warningDiv);
            document.getElementById('cameraWarning').style.display = 'block';
            
            setTimeout(() => {
                const warning = document.getElementById('camera-warning-' + camera.id);
                if (warning) {
                    warning.style.animation = 'fadeOut 0.5s';
                    setTimeout(() => {
                        if (warning.parentElement) {
                            warning.remove();
                            if (document.getElementById('cameraWarning').children.length === 0) {
                                document.getElementById('cameraWarning').style.display = 'none';
                            }
                        }
                    }, 500);
                }
            }, 10000);
        }

        // حساب الاتجاه بين نقطتين
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const λ1 = lon1 * Math.PI / 180;
            const λ2 = lon2 * Math.PI / 180;
            
            const y = Math.sin(λ2 - λ1) * Math.cos(φ2);
            const x = Math.cos(φ1) * Math.sin(φ2) -
                      Math.sin(φ1) * Math.cos(φ2) * Math.cos(λ2 - λ1);
            const θ = Math.atan2(y, x);
            
            return (θ * 180 / Math.PI + 360) % 360;
        }

        // تغيير طبقة الخريطة
        function toggleMapLayer() {
            const layers = {
                street: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                satellite: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                dark: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png'
            };
            
            const layerNames = Object.keys(layers);
            const currentIndex = layerNames.indexOf(currentMapLayer);
            const nextIndex = (currentIndex + 1) % layerNames.length;
            currentMapLayer = layerNames[nextIndex];
            
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            L.tileLayer(layers[currentMapLayer], {
                attribution: '© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            addRealCameraMarkersToMap();
            
            showAlert(`🌍 تم تغيير الخريطة إلى: ${currentMapLayer === 'street' ? 'شارع' : currentMapLayer === 'satellite' ? 'قمر صناعي' : 'داكن'}`, 'success');
        }

        function toggle3DMode() {
            map3DMode = !map3DMode;
            if (map3DMode) {
                map.setView(map.getCenter(), map.getZoom(), {
                    pitch: 60,
                    bearing: 30
                });
                showAlert('🎮 وضع ثلاثي الأبعاد مفعل', 'success');
            } else {
                map.setView(map.getCenter(), map.getZoom(), {
                    pitch: 0,
                    bearing: 0
                });
                showAlert('🗺️ وضع ثنائي الأبعاد مفعل', 'success');
            }
        }

        function centerMap() {
            if (lastPosition) {
                map.flyTo([lastPosition.latitude, lastPosition.longitude], 15, {
                    animate: true,
                    duration: 2
                });
            } else {
                showAlert('📍 لا يوجد موقع حالي - ابدأ التتبع أولاً', 'warning');
            }
        }

        function checkCameraDistance(cameraId) {
            if (!lastPosition) {
                showAlert('📍 لا يوجد موقع حالي - ابدأ التتبع أولاً', 'warning');
                return;
            }
            
            const camera = realSpeedCameras.find(c => c.id === cameraId);
            if (camera) {
                const distance = calculateDistance(
                    lastPosition.latitude, lastPosition.longitude,
                    camera.lat, camera.lng
                ) * 1000;
                
                const cameraType = camera.type === 'mobile' ? 'متحركة' : 'ثابتة';
                showAlert(`📏 المسافة إلى ${camera.name} (${cameraType}): ${Math.round(distance)} متر`, camera.type === 'mobile' ? 'camera-mobile' : 'camera-fixed');
                
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(`المسافة إلى الكاميرا ${Math.round(distance)} متر`);
                    utterance.lang = 'ar-SA';
                    speechSynthesis.speak(utterance);
                }
            }
        }

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('❌ متصفحك لا يدعم الصوت');
            }
        }

        function playBeep(freq = 800) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            gainNode.gain.value = 0.5;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function startTracking() {
            if (trackingInterval) {
                showAlert('⚠️ التتبع يعمل بالفعل', 'warning');
                return;
            }
            
            if (!navigator.geolocation) {
                showAlert('❌ متصفحك لا يدعم تحديد الموقع', 'danger');
                return;
            }
            
            startTime = new Date();
            showAlert('▶️ بدء تتبع السرعة والكشف عن الكاميرات الحقيقية (' + realSpeedCameras.length + ' كاميرة)', 'success');
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const speed = position.coords.speed ? position.coords.speed * 3.6 : 0;
                    
                    const trackPoint = {
                        time: new Date().toLocaleTimeString('ar-EG'),
                        speed: Math.round(speed * 10) / 10,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        direction: position.coords.heading || 0,
                        accuracy: Math.round(position.coords.accuracy),
                        timestamp: new Date().toISOString()
                    };
                    
                    trackPoints.push(trackPoint);
                    
                    if (lastPosition) {
                        const distance = calculateDistance(
                            lastPosition.latitude, lastPosition.longitude,
                            trackPoint.latitude, trackPoint.longitude
                        );
                        totalDistance += distance;
                    }
                    
                    lastPosition = trackPoint;
                    
                    if (speed > maxSpeed) {
                        maxSpeed = speed;
                    }
                    
                    checkNearbyCameras(trackPoint.latitude, trackPoint.longitude, speed);
                    
                    updateDisplay(speed);
                    updateMap(trackPoint);
                    
                },
                error => {
                    console.error('GPS Error:', error);
                    showAlert(`⚠️ خطأ GPS: ${error.message}`, 'warning');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
            
            trackingInterval = setInterval(updateTime, 1000);
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            showAlert('⏹️ تم إيقاف التتبع', 'info');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateDisplay(speed) {
            document.getElementById('currentSpeed').textContent = speed.toFixed(1);
            
            const maxGaugeSpeed = 200;
            const percentage = Math.min(speed / maxGaugeSpeed, 1);
            document.getElementById('gaugeFill').style.strokeDashoffset = 502 * (1 - percentage);
            
            if (trackPoints.length > 0) {
                const avgSpeed = trackPoints.reduce((sum, p) => sum + p.speed, 0) / trackPoints.length;
                document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1);
            }
            
            document.getElementById('distance').textContent = totalDistance.toFixed(2);
            document.getElementById('maxSpeed').textContent = maxSpeed.toFixed(1);
            document.getElementById('recordCount').textContent = `(${trackPoints.length})`;
            
            updateTable();
            updateCharts();
        }

        function updateTime() {
            if (startTime) {
                const elapsed = Math.floor((new Date() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                document.getElementById('tripTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateMap(point) {
            if (!map) return;
            
            const latlng = [point.latitude, point.longitude];
            
            marker.setLatLng(latlng);
            
            if (trackPoints.length > 1) {
                const routePoints = trackPoints.map(p => [p.latitude, p.longitude]);
                
                if (polyline) {
                    polyline.setLatLngs(routePoints);
                } else {
                    polyline = L.polyline(routePoints, {
                        color: 'var(--accent-color)',
                        weight: 4,
                        opacity: 0.7,
                        lineJoin: 'round'
                    }).addTo(map);
                }
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            trackPoints.slice(-10).reverse().forEach(point => {
                const row = tbody.insertRow();
                
                const nearbyAtPoint = realSpeedCameras.filter(camera => {
                    const distance = calculateDistance(point.latitude, point.longitude, camera.lat, camera.lng) * 1000;
                    return distance <= 1000;
                });
                
                const mobileNearby = nearbyAtPoint.filter(c => c.type === 'mobile').length;
                const fixedNearby = nearbyAtPoint.filter(c => c.type === 'fixed').length;
                
                let status = 'طبيعي';
                let statusColor = 'var(--success)';
                let cameraInfo = '';
                let closestDistance = '--';
                
                if (nearbyAtPoint.length > 0) {
                    cameraInfo = `📸 ${fixedNearby} ثابتة, 🚗 ${mobileNearby} متحركة`;
                    status = nearbyAtPoint.length > 2 ? '⚠️ منطقة كاميرات' : 'كاميرات قريبة';
                    statusColor = 'var(--warning)';
                    
                    const closest = Math.min(...nearbyAtPoint.map(c => 
                        calculateDistance(point.latitude, point.longitude, c.lat, c.lng) * 1000
                    ));
                    closestDistance = Math.round(closest) + ' م';
                }
                
                if (point.speed > 120) {
                    status = 'خطر';
                    statusColor = 'var(--danger)';
                }
                
                row.innerHTML = `
                    <td>${point.time}</td>
                    <td>${point.speed.toFixed(1)}</td>
                    <td>${point.latitude.toFixed(4)}°, ${point.longitude.toFixed(4)}°</td>
                    <td>${point.direction ? point.direction.toFixed(0) + '°' : '--'}</td>
                    <td style="color: var(--camera-fixed); font-size: 0.9em;">${cameraInfo || 'لا توجد'}</td>
                    <td>${closestDistance}</td>
                    <td style="color: ${statusColor}">${status}</td>
                `;
            });
        }

        function updateCharts() {
            const last20 = trackPoints.slice(-20);
            const labels = last20.map(p => p.time);
            
            if (speedChart) speedChart.destroy();
            
            const speedCtx = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(speedCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'السرعة (km/h)',
                        data: last20.map(p => p.speed),
                        borderColor: '#00d2ff',
                        backgroundColor: 'rgba(0, 210, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: last20.map(p => p.speed > 120 ? '#ff4444' : '#00d2ff')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'var(--text-primary)' } }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'var(--border-color)' },
                            title: { display: true, text: 'km/h', color: 'var(--text-secondary)' }
                        },
                        x: { 
                            grid: { color: 'var(--border-color)' },
                            ticks: { maxRotation: 45, minRotation: 45 }
                        }
                    }
                }
            });
            
            if (analysisChart) analysisChart.destroy();
            
            const analysisCtx = document.getElementById('analysisChart').getContext('2d');
            analysisChart = new Chart(analysisCtx, {
                type: 'doughnut',
                data: {
                    labels: ['أقل من 80', '80 - 120', 'أكثر من 120'],
                    datasets: [{
                        data: [
                            trackPoints.filter(p => p.speed < 80).length,
                            trackPoints.filter(p => p.speed >= 80 && p.speed <= 120).length,
                            trackPoints.filter(p => p.speed > 120).length
                        ],
                        backgroundColor: ['#00ff88', '#ffaa00', '#ff4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: 'var(--text-primary)' },
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function showAlert(message, type = 'warning') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            
            let icon = 'fa-exclamation-triangle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'danger') icon = 'fa-exclamation-circle';
            if (type === 'camera-fixed') icon = 'fa-video';
            if (type === 'camera-mobile') icon = 'fa-car';
            
            alert.innerHTML = `<i class="fas ${icon}" style="color: var(--${type === 'camera-fixed' ? 'camera-fixed' : type === 'camera-mobile' ? 'camera-mobile' : type})"></i>${message}`;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'slideIn 0.5s reverse';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        }

        function saveToLocal() {
            if (trackPoints.length === 0) {
                showAlert('📭 لا توجد بيانات للحفظ', 'warning');
                return;
            }
            
            const data = {
                trackPoints: trackPoints,
                totalDistance: totalDistance,
                maxSpeed: maxSpeed,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('carSpeedData', JSON.stringify(data));
            showAlert('💾 تم حفظ البيانات بنجاح', 'success');
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('carSpeedData');
            if (saved) {
                const data = JSON.parse(saved);
                trackPoints = data.trackPoints || [];
                totalDistance = data.totalDistance || 0;
                maxSpeed = data.maxSpeed || 0;
                
                updateDisplay(0);
                updateCharts();
                updateTable();
                
                showAlert('✅ تم تحميل البيانات', 'success');
            } else {
                showAlert('📭 لا توجد بيانات محفوظة', 'info');
            }
        }

        function exportData() {
            if (trackPoints.length === 0) {
                showAlert('📭 لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            const csv = trackPoints.map(p => 
                `${p.time},${p.speed},${p.latitude},${p.longitude},${p.direction || ''},${p.accuracy}`
            ).join('\n');
            
            const header = 'الوقت,السرعة,خط العرض,خط الطول,الاتجاه,الدقة\n';
            const blob = new Blob([header + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `رحلة_السيارة_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showAlert('📥 تم تصدير البيانات', 'success');
        }

        function shareLocation() {
            if (!lastPosition) {
                showAlert('📍 لا يوجد موقع حالي', 'warning');
                return;
            }
            
            const nearby = realSpeedCameras.filter(camera => {
                const distance = calculateDistance(lastPosition.latitude, lastPosition.longitude, camera.lat, camera.lng) * 1000;
                return distance <= 2000;
            });
            
            const cameraText = nearby.length > 0 ? 
                `\n📸 كاميرات قريبة: ${nearby.length} (${nearby.filter(c => c.type === 'mobile').length} متحركة)` : '';
            
            const text = `🚗 موقعي الحالي:\n📍 خط العرض: ${lastPosition.latitude}\n📍 خط الطول: ${lastPosition.longitude}\n⚡ السرعة: ${lastPosition.speed} km/h\n🕐 الوقت: ${lastPosition.time}${cameraText}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'مشاركة موقعي مع الكاميرات القريبة',
                    text: text
                }).catch(() => {
                    navigator.clipboard.writeText(text);
                    showAlert('📋 تم نسخ الموقع مع معلومات الكاميرات', 'success');
                });
            } else {
                navigator.clipboard.writeText(text);
                showAlert('📋 تم نسخ الموقع مع معلومات الكاميرات', 'success');
            }
        }

        function clearData() {
            if (confirm('⚠️ هل أنت متأكد من مسح جميع البيانات؟')) {
                trackPoints = [];
                totalDistance = 0;
                maxSpeed = 0;
                lastPosition = null;
                
                updateDisplay(0);
                document.getElementById('tripTime').textContent = '00:00:00';
                document.getElementById('avgSpeed').textContent = '0';
                document.getElementById('nearbyCameras').textContent = '0';
                document.getElementById('mobileNearby').textContent = '0';
                
                if (polyline) {
                    polyline.remove();
                    polyline = null;
                }
                
                localStorage.removeItem('carSpeedData');
                
                if (speedChart) speedChart.destroy();
                if (analysisChart) analysisChart.destroy();
                
                showAlert('🗑️ تم مسح جميع البيانات', 'info');
            }
        }

        function setTheme(theme) {
            const themes = {
                default: 'داكن جداً',
                dark: 'داكن',
                light: 'فاتح'
            };
            
            document.documentElement.setAttribute('data-theme', theme);
            
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(themes[theme])) {
                    btn.classList.add('active');
                }
            });
            
            showAlert(`🎨 تم تغيير السمة إلى: ${themes[theme]}`, 'success');
        }

        // ==================== التهيئة ====================
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            setTimeout(initMap, 500);
            loadFromLocal();
            updateCameraStats();
            
            gsap.from(".header", { y: -100, opacity: 0, duration: 1 });
            gsap.from(".speed-gauge", { scale: 0, duration: 1, delay: 0.5, ease: "elastic" });
            gsap.from(".metric-card", { scale: 0, opacity: 0, duration: 0.8, stagger: 0.2 });
            
            document.getElementById('cameraToggle').classList.add('active');
            document.getElementById('cameraStatus').textContent = 'مفعل';
            
            showAlert(`🚀 النظام جاهز للعمل - ${realSpeedCameras.length} كاميرة حقيقية محدثة 19 فبراير 2026`, 'success');
            showAlert('📢 يمكنك الإبلاغ عن الكاميرات المتحركة عبر زر "الإبلاغ"', 'camera-mobile');
        });

        window.addEventListener('beforeunload', () => {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            if (trackingInterval) clearInterval(trackingInterval);
        });
    </script>
</body>
</html>